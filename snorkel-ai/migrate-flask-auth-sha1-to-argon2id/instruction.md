# Migrate Flask Auth Service from SHA-1 to Argon2id

A legacy Flask authentication service currently stores unsalted SHA-1 password hashes, which is a critical security vulnerability. You must refactor the service to use Argon2id with per-user random salts and configurable memory/time parameters, implement automatic rehash-on-login when parameters are outdated, and provide a CLI tool to bulk-migrate existing users by validating credentials from a CSV file.

## Requirements

1. **Refactor authentication service**: Update `/app/auth_service.py` to use Argon2id password hashing instead of SHA-1. The service must:
   - Hash new passwords with Argon2id using per-user random salts
   - Support configurable memory and time parameters (read from `/app/argon2_config.json`)
   - Automatically rehash passwords on successful login when the stored hash uses outdated parameters (compare against current config)
   - Maintain backward compatibility to verify existing SHA-1 hashes during migration period
   - Update user records in-place in `/app/users.json`

2. **Implement migration CLI**: Complete `/app/migrate.py` to bulk-migrate users from SHA-1 to Argon2id:
   - Read login attempts from `/app/login_attempts.csv` (format: `username,password`)
   - Treat the first row as a header and skip it
   - CSV rows are plain, comma-separated `username,password` values with no quoting; assume passwords do not contain commas
   - Strip surrounding whitespace in usernames/passwords and skip empty rows
   - For each row, validate the password against the current SHA-1 hash in `/app/users.json`
   - If validation succeeds, compute new Argon2id hash using current config parameters and update the user record
   - If validation fails (wrong password), skip the user and record in audit log
   - Continue processing all rows even if some fail
   - The migration must run when executing `python3 /app/migrate.py` with no extra arguments
   - The provided CSV contains valid credentials for at least four users (alice, bob, charlie, diana); those users must be migrated when the script runs

3. **Generate audit report**: After migration completes, write `/app/audit.json` containing:
   - `migrated_count`: Number of users successfully migrated
   - `failed_count`: Number of users that could not be migrated
   - `failed_users`: Array of usernames that failed migration (due to incorrect passwords)
   - Record at least the users that fail password verification in `failed_users`

4. **Maintain service functionality**: The Flask service must continue to:
   - Accept POST requests to `/login` with JSON body `{"username": "...", "password": "..."}`
   - Return `200 OK` with `{"status": "success"}` on valid login
   - Return `401 Unauthorized` with `{"status": "error", "message": "Invalid credentials"}` on invalid login
   - Automatically rehash passwords when login succeeds but hash parameters are outdated
   - Listen on port `5000` so the service is reachable at `http://localhost:5000`

## Constraints

- **Do not modify** `/app/login_attempts.csv` or `/app/users.json` structure (only update hash values)
- **Do not remove** existing SHA-1 verification logic until migration is complete (backward compatibility required)
- **Use Argon2id** (not Argon2i or Argon2d) - this is the recommended variant for password hashing
- **Per-user salts**: Each user must have a unique random salt (not shared across users)
- **Configurable parameters**: Read `memory_cost`, `time_cost`, and `parallelism` from `/app/argon2_config.json`
- **Current Argon2 config values**: `memory_cost=65536`, `time_cost=3`, `parallelism=4` (use these exact values from the file)
- **Rehash detection**: Compare stored hash parameters with current config; rehash if memory_cost or time_cost differ
- **CLI must be idempotent**: Running migration multiple times should not duplicate entries in audit.json
- **Port**: Do not change the Flask port (keep `5000`)
- **No external network calls**: All operations must work offline
- **Python 3.11+** with `argon2-cffi` library (already in requirements)

## Files

- Authentication service: `/app/auth_service.py` (Flask app with broken/incomplete Argon2id implementation)
- User database: `/app/users.json` (JSON file with user records containing SHA-1 hashes)
- Migration CLI: `/app/migrate.py` (incomplete migration script)
- Login attempts CSV: `/app/login_attempts.csv` (contains `username,password` pairs for migration)
- Argon2 configuration: `/app/argon2_config.json` (contains `memory_cost`, `time_cost`, `parallelism` parameters)
- Audit output: `/app/audit.json` (generated by migration CLI)

## Outputs

- Updated `/app/users.json` (all migratable users converted to Argon2id hashes)
- `/app/audit.json` (JSON file with migration statistics and failed usernames)

## Technical Notes

- Argon2id hashes include the salt and parameters in the hash string itself (standard format)
- Use `argon2.hash_password()` to create new hashes and `argon2.verify_password()` to verify
- SHA-1 hashes are 40-character hexadecimal strings (no salt prefix)
- Argon2id hashes start with `$argon2id$` and include version, memory, time, parallelism, salt, and hash
- When rehashing on login, use the same password that was just verified (don't prompt again)
