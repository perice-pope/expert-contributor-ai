# Configure Bazel Remote Cache and Verify Cache Hit Rate

A Bazel workspace contains a mixed C++/Java project but is not configured to use a remote cache. You must configure the workspace to use a local HTTP remote cache server (bazel-remote) that persists cache entries under `/cache`, build the project to prime the cache, then simulate a fresh checkout and rebuild. The second build must achieve >95% remote cache hits with no compile actions executed, as verified by Bazel's build event summary.

## Requirements

1. **Configure Bazel remote cache**: Update the Bazel workspace configuration to use an HTTP remote cache:
   - Configure Bazel to use `http://localhost:8080` as the remote cache endpoint
   - Ensure the cache configuration is persistent (survives workspace rebuilds)
   - The bazel-remote server will be running and listening on port 8080 with cache storage at `/cache`

2. **Build project to prime cache**: Execute a clean build of the mixed C++/Java project:
   - Build all targets in the workspace
   - This build will populate the remote cache with artifacts
   - Verify the build completes successfully

3. **Simulate fresh checkout**: After the initial build, simulate a fresh checkout scenario:
   - Clean the Bazel output directories (e.g., `bazel clean --expunge`)
   - Remove local build artifacts but preserve the cache configuration
   - This simulates checking out the project on a new machine or after a clean

4. **Rebuild and verify cache hits**: Execute a second build and verify cache effectiveness:
   - Rebuild the same targets
   - Extract cache hit statistics from Bazel's build event summary
   - Verify that >95% of actions result in remote cache hits
   - Verify that no compile actions (C++ compilation, Java compilation) are executed in the second build
   - The build event summary must show cache hits for compilation actions

5. **Generate verification report**: Create a report file documenting the cache performance:
   - Write `/app/cache_verification.json` containing:
     - `cache_hit_percentage`: Percentage of actions that hit the cache (must be >95)
     - `compile_actions_executed`: Number of compile actions executed (must be 0)
     - `total_actions`: Total number of actions in the build
     - `cache_hit_actions`: Number of actions that hit the cache
     - `build_successful`: Boolean indicating if the second build succeeded

## Constraints

- **Do not modify** the BUILD files or source code structure (only configure cache settings)
- **Do not modify** the bazel-remote server configuration or startup
- **Use Bazel's native remote cache configuration** (via `.bazelrc` or command-line flags)
- **Cache must persist** under `/cache` directory (managed by bazel-remote)
- **Verification must use Bazel's build event protocol** (BEP) to extract statistics
- **No network calls** beyond localhost:8080 for cache operations
- **Bazel version**: Use the version installed in the environment (verify with `bazel version`)
- **Cache configuration must be workspace-scoped** (not user-global)

## Files

- Bazel workspace: `/app/` (contains `WORKSPACE` or `MODULE.bazel`, `BUILD` files, and source code)
- C++ source files: `/app/cpp/` (C++ source code and BUILD targets)
- Java source files: `/app/java/` (Java source code and BUILD targets)
- Bazel configuration: `/app/.bazelrc` (may exist or need to be created)
- Cache verification output: `/app/cache_verification.json` (generated by your solution)

## Outputs

- Updated Bazel configuration (`.bazelrc` or equivalent) that enables remote cache
- `/app/cache_verification.json` (JSON file with cache hit statistics and verification results)

## Technical Notes

- Bazel remote cache is configured via `--remote_cache` flag or `.bazelrc` entries
- Build event summary can be generated with `--build_event_json_file` flag
- Cache hit statistics are available in the build event protocol output
- The bazel-remote server runs as a separate process (already started in the environment)
- To extract cache statistics, parse the build event JSON and count actions with `cacheHit: true`
- Compile actions can be identified by action type (e.g., `CppCompile`, `Javac`)
- A "fresh checkout" simulation requires `bazel clean --expunge` to remove all local state
- The second build should show cache hits for compilation actions, not just other action types
